name: "Build-Push-image"

on:
  push:
    branches:
      - main

  workflow_dispatch:  

env:
  CLUSTER_NAME: contoso-video
  RESOURCE_GROUP: mslearn-gh-pipelines-5163
  NAMESPACE: index-app-ns
  IMAGE_NAME: index-app
  HELM_RELEASE_NAME: index-app
  HELM_CHART_PATH: ./helm-charts/index-app
  APP_VERSION: 1.0.0-${{ github.sha }}
  HELM_CHART_VERSION: 1.0-${{ github.sha }}

jobs:
  # BASIC CI Workflow
  build:
    runs-on: ubuntu-latest
    steps:
    - name: "Checkout repository"
      uses: actions/checkout@master
    
    - uses: Azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_URL }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
    
    - name: "Build and push to container registry"
      run: |
        docker build . -t ${{ secrets.ACR_URL }}/${{env.IMAGE_NAME}}:${{ github.sha }}
        docker push ${{ secrets.ACR_URL }}/${{env.IMAGE_NAME}}:${{ github.sha }}
